# ============================================================================
# 项目 Makefile 配置文件
# ============================================================================
# 这个 Makefile 会自动查找并编译项目中的所有源文件
# 适合初学者理解和使用
# ============================================================================

# ----------------------------------------------------------------------------
# 编译器和编译选项配置
# ----------------------------------------------------------------------------
# CC: 使用 g++ 编译器（C++ 编译器）
CC = g++
# 编译选项说明：
#   -Wall: 显示所有警告信息，帮助发现潜在问题
#   -O2: 开启二级优化，让程序运行更快
#   -pthread: 支持多线程编程
CFLAGS = -Wall -O2 -pthread

# ----------------------------------------------------------------------------
# 目录结构配置
# ----------------------------------------------------------------------------
# 源文件目录（.cpp 文件存放位置）
SRC_DIR = src
# 头文件目录（.h 文件存放位置）
INC_DIR = include
# 编译生成的中间文件存放目录
BUILD_DIR = build
# 最终生成的可执行文件名
TARGET = main

# ----------------------------------------------------------------------------
# 自动搜索源文件和头文件
# ----------------------------------------------------------------------------
# wildcard 函数：搜索指定模式的所有文件
# 例如：$(wildcard src/*.cpp) 会找到 src 目录下所有 .cpp 文件
SOURCES = $(wildcard $(SRC_DIR)/*.cpp) main.cpp
                                  # SOURCES: 所有需要编译的 .cpp 源文件
                                  # 包括 src 目录下的所有 cpp 文件和主程序 main.cpp

# INCLUDES: 告诉编译器去哪里找头文件
#   -I 选项用于指定头文件搜索路径
INCLUDES = -I$(INC_DIR)

# ----------------------------------------------------------------------------
# 自动生成目标文件列表
# ----------------------------------------------------------------------------
# patsubst 函数：模式替换，把一种文件名转换成另一种
# 语法：$(patsubst 原模式, 新模式, 文件列表)
# 这里把所有 .cpp 文件名改成 .o 文件名，并放到 build 目录下
OBJECTS = $(patsubst %.cpp, $(BUILD_DIR)/%.o, $(notdir $(SOURCES)))
                                  # notdir: 去掉文件路径，只保留文件名
                                  # 例如：src/timer.cpp -> timer.cpp
                                  # 然后替换成：build/timer.o

# 定义搜索路径，让 make 知道去哪里找源文件
VPATH = $(SRC_DIR):./            # VPATH: 源文件搜索路径
                                  # make 会在这些目录中查找 .cpp 文件

# ----------------------------------------------------------------------------
# 默认目标：编译整个项目
# ----------------------------------------------------------------------------
# 当你在命令行输入 "make" 时，会执行第一个目标
all: init_build_dir $(TARGET)
	@echo "================================================"
	@echo "✓ 编译完成！"
	@echo "✓ 可执行文件: $(TARGET)"
	@echo "✓ 运行命令: ./$(TARGET)"
	@echo "================================================"

# ----------------------------------------------------------------------------
# 创建 build 目录（如果不存在）
# ----------------------------------------------------------------------------
init_build_dir:
	@echo "创建编译输出目录: $(BUILD_DIR)/"
	@mkdir -p $(BUILD_DIR)        # -p 选项：如果目录已存在，不报错

# ----------------------------------------------------------------------------
# 链接目标：将所有 .o 文件链接成可执行文件
# ----------------------------------------------------------------------------
$(TARGET): $(OBJECTS)
	@echo "正在链接生成可执行文件: $@"
	$(CC) $(CFLAGS) $(OBJECTS) -o $@
	@echo "✓ 链接完成"
	# $@ 代表目标文件名，这里是 $(TARGET)，即 main
	# 链接：把所有编译好的 .o 文件组合成一个可执行程序

# ----------------------------------------------------------------------------
# 编译规则：将 .cpp 源文件编译成 .o 目标文件
# ----------------------------------------------------------------------------
# 这条规则告诉 make 如何从 .cpp 文件生成 .o 文件
# 当 .cpp 文件或任何头文件修改时，对应的 .o 文件会重新编译
$(BUILD_DIR)/%.o: %.cpp $(wildcard $(INC_DIR)/*.h) | init_build_dir
	@echo "正在编译: $< -> $@"
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@
	# $< 代表第一个依赖文件（.cpp 文件）
	# $@ 代表目标文件（.o 文件）
	# -c 选项：只编译不链接，生成 .o 目标文件
	# | init_build_dir 表示顺序依赖（order-only），确保目录先创建

# ----------------------------------------------------------------------------
# 清理命令：删除所有编译生成的文件
# ----------------------------------------------------------------------------
clean:
	@echo "正在清理编译文件..."
	rm -rf $(BUILD_DIR) $(TARGET)
	@echo "✓ 清理完成"
	# 删除 build 目录和可执行文件

# ----------------------------------------------------------------------------
# 重新编译：先清理再编译
# ----------------------------------------------------------------------------
rebuild: clean all
	@echo "✓ 重新编译完成"


# ----------------------------------------------------------------------------
# 帮助信息：显示可用的命令
# ----------------------------------------------------------------------------
help:
	@echo "================================================"
	@echo "Makefile 使用说明"
	@echo "================================================"
	@echo "make          - 编译项目（默认命令）"
	@echo "make all      - 编译项目"
	@echo "make clean    - 清理所有编译生成的文件"
	@echo "make rebuild  - 清理后重新编译"
	@echo "make help     - 显示此帮助信息"
	@echo "================================================"

# ----------------------------------------------------------------------------
# 声明伪目标
# ----------------------------------------------------------------------------
# .PHONY 声明这些目标不是真实的文件，而是命令
.PHONY: all clean rebuild run help init_build_dir